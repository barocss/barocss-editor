# DOM Creation/Attribute Commit Timing (Same Flow as React)

## Overall Overview

| Phase | Render Phase (`renderFiberNode`) | Commit Phase (`commitFiberNode`) |
| --- | --- | --- |
| DOM Creation | Only **create** Text/Host DOM (no insertion) | Insert/reposition already created DOM to parent |
| Attributes/Styles | **Not set** | Call `dom.updateAttributes` / `dom.updateStyles` |
| Text | Only create text node | Apply final text via `handleVNodeTextProperty`, etc. |
| Order Determination | Only prepare Fiber tree information | Find next sibling DOM with `getHostSibling` then `insertBefore` |

## Render Phase Details (Same as React `completeWork`)

```typescript
if (prevVNode?.meta?.domElement) {
  domElement = prevVNode.meta.domElement;
} else if (vnode.tag === '#text') {
  domElement = document.createTextNode(vnode.text);
} else if (vnode.tag) {
  domElement = dom.createSimpleElement(vnode.tag);
  if (vnode.sid && !isAutoGeneratedSid(vnode)) {
    dom.setAttribute(domElement, 'data-bc-sid', vnode.sid);
  }
  if (vnode.attrs) {
    for (const [key, value] of Object.entries(vnode.attrs)) {
      dom.setAttribute(domElement, key, String(value));
    }
  }
}
vnode.meta.domElement = domElement;
fiber.domElement = domElement;
```

- DOM is **created in advance but not attached to parent**
- Attributes/styles are not set at this phase (only minimal identifiers set)

## Commit Phase Details (React `commitPlacement` + `commitUpdate`)

```typescript
if (fiber.effectTag === 'PLACEMENT') {
  const parent = fiber.parentFiber.domElement;
  let before = getHostSibling(fiber);
  if (before && before.parentNode !== parent) before = null;
  parent.insertBefore(domElement, before); // Only insertion
}

if (domElement instanceof HTMLElement) {
  dom.updateAttributes(domElement, prevVNode?.attrs, vnode.attrs); // Insert / Update / Delete all handled by this function via diff
  dom.updateStyles(domElement, prevVNode?.style, vnode.style);
}

if (domElement instanceof HTMLElement && vnode.text && !vnode.children) {
  handleVNodeTextProperty(domElement, vnode, prevVNode); // Text property commit
}
```

- **Insertion (Placement)**: Only `insertBefore` is performed. Uses `getHostSibling` like React to find next sibling DOM and use as reference node.
- **Attribute/Style Commit**: `dom.updateAttributes`/`updateStyles` handle Insert/Update/Delete concepts (compare with previous values and remove missing ones with `removeAttribute`, etc.).
- **Text Update**: `handleVNodeTextProperty` only updates text inside node.
- **Deletion**: Removing DOM node itself also removes attributes/text together.

## `getHostSibling` (React Algorithm)

```typescript
let sibling = fiber.sibling;
while (sibling) {
  if (sibling.domElement) return sibling.domElement;
  if (sibling.child) {
    let child = sibling.child;
    while (child) {
      if (child.domElement) return child.domElement;
      child = child.child;
    }
  }
  sibling = sibling.sibling;
}
return null;
```

- Since DOM is already created in Render Phase, reference node can be obtained immediately at commit time.
- If reference node does not belong to parent, downgrade to `null` to handle same as `appendChild` (React uses same approach).

## Attribute Insert / Update / Delete Concepts

- **Insert**: When new DOM element is Placement'd, `dom.updateAttributes(undefined, newAttrs)` sets all attributes initially.
- **Update**: Compare existing element's attrs/style with previous values and apply only changed parts.
- **Delete**: Attributes/styles that existed before but not now are handled with `removeAttribute`/style reset. If node itself is deleted, attributes disappear together.

> **Conclusion:** Render Phase only "prepares" DOM, and Commit Phase handles insertion/attributes/styles/text/deletion, so it follows the exact same flow as React.
