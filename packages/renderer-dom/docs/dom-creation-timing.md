# DOM 생성/속성 커밋 시점 (React 동일 흐름)

## 전체 개요

| 단계 | Render Phase (`renderFiberNode`) | Commit Phase (`commitFiberNode`) |
| --- | --- | --- |
| DOM 생성 | Text/Host DOM **생성만** 수행 (삽입 없음) | 이미 생성된 DOM을 부모에 삽입/재배치 |
| 속성/스타일 | **설정하지 않음** | `dom.updateAttributes` / `dom.updateStyles` 호출 |
| 텍스트 | Text node 생성만 수행 | `handleVNodeTextProperty` 등으로 최종 텍스트 반영 |
| 순서 결정 | Fiber 트리 정보만 준비 | `getHostSibling`으로 다음 형제 DOM 찾은 뒤 `insertBefore` |

## Render Phase 세부 (React `completeWork`와 동일)

```typescript
if (prevVNode?.meta?.domElement) {
  domElement = prevVNode.meta.domElement;
} else if (vnode.tag === '#text') {
  domElement = document.createTextNode(vnode.text);
} else if (vnode.tag) {
  domElement = dom.createSimpleElement(vnode.tag);
  if (vnode.sid && !isAutoGeneratedSid(vnode)) {
    dom.setAttribute(domElement, 'data-bc-sid', vnode.sid);
  }
  if (vnode.attrs) {
    for (const [key, value] of Object.entries(vnode.attrs)) {
      dom.setAttribute(domElement, key, String(value));
    }
  }
}
vnode.meta.domElement = domElement;
fiber.domElement = domElement;
```

- DOM은 **미리 만들어 두지만 부모에 붙이지 않음**
- 속성/스타일도 이 단계에서는 부여하지 않음 (필요 최소한의 식별자만 세팅)

## Commit Phase 세부 (React `commitPlacement` + `commitUpdate`)

```typescript
if (fiber.effectTag === 'PLACEMENT') {
  const parent = fiber.parentFiber.domElement;
  let before = getHostSibling(fiber);
  if (before && before.parentNode !== parent) before = null;
  parent.insertBefore(domElement, before); // 삽입만 수행
}

if (domElement instanceof HTMLElement) {
  dom.updateAttributes(domElement, prevVNode?.attrs, vnode.attrs); // Insert / Update / Delete 모두 이 함수가 diff
  dom.updateStyles(domElement, prevVNode?.style, vnode.style);
}

if (domElement instanceof HTMLElement && vnode.text && !vnode.children) {
  handleVNodeTextProperty(domElement, vnode, prevVNode); // 텍스트 속성 커밋
}
```

- **삽입(Placement)**: `insertBefore`만 수행. React처럼 `getHostSibling`을 사용해 다음 형제 DOM을 찾아 reference node로 사용.
- **속성/스타일 커밋**: `dom.updateAttributes`/`updateStyles`가 Insert/Update/Delete 개념을 모두 담당 (이전 값과 비교해 부족분은 `removeAttribute` 등으로 삭제).
- **텍스트 업데이트**: `handleVNodeTextProperty`가 node 내부 텍스트만 갱신.
- **Deletion**: DOM 노드 자체를 제거하면 속성/텍스트도 함께 사라짐.

## `getHostSibling` (React 알고리즘)

```typescript
let sibling = fiber.sibling;
while (sibling) {
  if (sibling.domElement) return sibling.domElement;
  if (sibling.child) {
    let child = sibling.child;
    while (child) {
      if (child.domElement) return child.domElement;
      child = child.child;
    }
  }
  sibling = sibling.sibling;
}
return null;
```

- Render Phase에서 이미 DOM을 생성해 두었기 때문에 commit 시점에 바로 reference node를 얻을 수 있음.
- reference node가 부모에 속하지 않으면 `null`로 강등해 `appendChild`와 동일하게 처리 (React도 같은 방식을 사용).

## 속성 Insert / Update / Delete 개념

- **Insert**: 새 DOM 요소가 Placement될 때 `dom.updateAttributes(undefined, newAttrs)`가 모든 속성을 초기 세팅.
- **Update**: 기존 요소의 attrs/style을 이전 값과 비교해 변경된 부분만 적용.
- **Delete**: 이전엔 있었지만 이번엔 없는 속성/스타일은 `removeAttribute`/스타일 초기화로 처리. 노드 자체가 삭제되면 속성도 함께 사라짐.

> **결론:** Render Phase에서 DOM을 “준비”만 하고, Commit Phase에서 삽입/속성/스타일/텍스트/삭제를 모두 처리하므로 React와 완전히 동일한 흐름을 가지게 되었습니다.

