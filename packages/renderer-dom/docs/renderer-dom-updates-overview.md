# renderer-dom Changes Overview

This document summarizes major modifications made in the `renderer-dom` package and resulting behavior. All content is based on the current `fix/renderer-dom-tests` branch.

## 1. Fiber and Reconciler Structure
- Created new `src/reconcile/fiber/` directory to separate scheduler, tree, and reconcile functionality. `FiberScheduler` detects Vitest execution with `detectTestEnvironment()` and switches to sync mode during tests. In sync mode, `performUnitOfWork` is executed immediately without `requestIdleCallback` and proceeds to commit phase at once.
- `reconcile/reconciler.ts` uses `cloneVNodeTree` (new) to deep copy previous VNode and store in `prevVNodeTree` to prevent `meta.domElement` loss. This enables accurate host matching on re-render.
- Host-related utilities like `host-management.ts`, `host-finding.ts`, `dom-utils.ts` strengthened global search fallback and sid-based reuse logic. When existing DOM nodes cannot be found, searches entire document, and doesn't call `mountComponent` again if component already mounted.
- `namespace-utils.ts`, `meta-utils.ts`, `text-node-handlers.ts` were supplemented to perform consistent DOM manipulation in Fiber path, and unnecessary child-processing utility (`src/reconcile/utils/child-processing.ts`) was removed.

## 2. VNode and Component Identity
- `component-manager.ts`'s `generateComponentId` supports `stype-index` pattern so components without sid also have stable ID based on position.
- `vnode/factory.ts`, `vnode/utils/component-identity-application.ts` auto-generate sid when `stype` exists, then record source with `markAutoGeneratedSid` (new `vnode/utils/sid-source.ts`). When outputting to DOM, `dom-operations.ts` doesn't expose auto-generated sid as `data-bc-sid`, only leaves model-provided sid as DOM attribute.
- `vnode/utils/build-guard.ts` tracks template build sections. `BaseComponentState.set()` silently ignores when called during build to prevent `queueMicrotask` loop from stacking infinitely.

## 3. Test and Runtime Support
- `test/setup.ts` forcibly sets `process.env.VITEST`, `NODE_ENV=test`, `globalThis.vitest`, etc. before all Vitest executions. This allows `FiberScheduler` to automatically select sync mode.
- Wait logic based on `test/utils/fiber-wait.ts` is no longer needed and deleted or references removed, and each test verifies DOM results immediately.
- Selection node reuse related tests (`reconciler-selection-pool.behavior.test.ts`, `reconciler-selection-preservation.test.ts`, `vnode-selection-anchoring.test.ts`) were removed due to requirement changes.
- `reconciler-performance.test.ts` introduced temporary debug mode (common count 10, `[PERF-TEST]` logs) for problem analysis. Actual performance number restoration will proceed after debugging completes.
- Most core tests (`component-state-integration`, `mark-wrapper-reuse`, `prevvnode-nextvnode`, `text-vnode`, `advanced-cases`, etc.) can now run individually in sync mode, and results documented in `test/RECONCILE_TEST_RESULTS.md`, etc.

## 4. Documentation and Analysis Materials
- Added following documents under `packages/renderer-dom/docs/`.
  - `fiber-sync-mode-implementation.md`, `fiber-sync-vs-async.md`, `renderer-async-consideration.md`: Explain Fiber sync mode design, async mode maintenance strategy, DOMRenderer re-render scenarios.
  - `mountcomponent-issue-analysis.md`, `decorator-removal-issue.md`, `fiber-dom-structure-issue.md`, `fiber-primitive-text-concept.md`, `fiber-no-arbitrary-elements.md`, `reconciler-fiber-review.md`: Analyze and record solutions for previously discovered DOM duplication, decorator cleanup, text node processing issues.
  - `unused-code-cleanup.md`, `fiber-migration-status.md`: Track removed utilities and ongoing Fiber transition status.
- Test results and failure analysis organized step-by-step in `test/FAILED_TESTS_ANALYSIS.md`, `FINAL_TEST_RESULTS.md`, `SYNC_MODE_TEST_RESULTS*.md`, `RECONCILE_TEST_CHECKLIST.md`, etc.

## 5. Functional Results Summary
1. **Test Reliability**: All reconcile-related tests run deterministically in sync mode. `waitForFiber()` dependency removed, simplifying maintenance.
2. **DOM Stability**: Deep copy of `prevVNode` and improved host matching prevent duplicate DOM creation or `mountComponent` re-calls even when same sid elements move.
3. **State Management**: Blocking `BaseComponentState.set()` calls during build eliminated `queueMicrotask` explosion, and state emit tests complete immediately.
4. **Identifier Consistency**: Auto sid only used internally and not exposed to DOM, distinguishing from model-provided sid. `data-bc-sid` only exists for model-injected sid.
5. **Documentation and Analysis System**: All problem causes, solution strategies, and test results preserved in separate documents for future regression analysis reference.

With these changes, `renderer-dom` is organized with sync test support, stable Fiber reconciliation, and clear sid policy. When adding tests or adjusting performance, impacts can be quickly identified based on this document.
