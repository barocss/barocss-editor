# renderer-dom 변경 사항 개요

최근 `renderer-dom` 패키지에서 진행된 주요 수정 사항과 그에 따른 동작 방식을 정리한다. 모든 내용은 현재 `fix/renderer-dom-tests` 브랜치 기준이다.

## 1. Fiber 및 리컨실러 구조
- `src/reconcile/fiber/` 디렉터리를 신설해 스케줄러, 트리, 리컨실 기능을 분리했다. `FiberScheduler` 는 `detectTestEnvironment()` 로 Vitest 실행 여부를 감지하고 테스트 시 동기 모드로 전환한다. 동기 모드에서는 `requestIdleCallback` 없이 `performUnitOfWork` 를 즉시 수행하고 커밋 단계까지 한 번에 진행한다.
- `reconcile/reconciler.ts` 는 `cloneVNodeTree`(신규) 로 이전 VNode 를 깊은 복사 후 `prevVNodeTree` 에 저장해 `meta.domElement` 손실을 막는다. 이로 인해 재랜더 시 정확한 host 매칭이 가능해졌다.
- `host-management.ts`, `host-finding.ts`, `dom-utils.ts` 등 host 관련 유틸은 전역 검색 fallback 과 sid 기반 재사용 로직을 강화했다. 기존 DOM 노드를 찾지 못할 때 문서 전체를 훑어보고, 이미 마운트된 컴포넌트면 `mountComponent` 를 다시 호출하지 않는다.
- `namespace-utils.ts`, `meta-utils.ts`, `text-node-handlers.ts` 는 Fiber 경로에서도 일관된 DOM 조작을 하도록 보완되었고, 불필요한 child-processing 유틸(`src/reconcile/utils/child-processing.ts`)은 제거됐다.

## 2. VNode 및 컴포넌트 아이덴티티
- `component-manager.ts` 의 `generateComponentId` 가 `stype-index` 패턴을 지원해 sid 가 없는 컴포넌트도 위치 기반으로 안정적인 ID 를 갖는다.
- `vnode/factory.ts`, `vnode/utils/component-identity-application.ts` 는 `stype` 존재 시 자동 sid 생성 후 `markAutoGeneratedSid`(신규 `vnode/utils/sid-source.ts`) 로 출처를 기록한다. DOM 출력 시 `dom-operations.ts` 는 자동 생성 sid 를 `data-bc-sid` 로 노출하지 않고, 모델이 제공한 sid 만 DOM attribute 로 남긴다.
- `vnode/utils/build-guard.ts` 는 템플릿 빌드 구간을 추적한다. `BaseComponentState.set()` 은 빌드 중 호출되면 조용히 무시하여 `queueMicrotask` 루프가 무한히 쌓이지 않도록 했다.

## 3. 테스트 및 런타임 지원
- `test/setup.ts` 를 통해 모든 Vitest 실행 전에 `process.env.VITEST`, `NODE_ENV=test`, `globalThis.vitest` 등을 강제로 설정한다. 덕분에 `FiberScheduler` 가 자동으로 동기 모드를 선택한다.
- `test/utils/fiber-wait.ts` 기반 대기 로직은 더 이상 필요 없어 삭제되거나 참조가 제거되었고, 각 테스트는 즉시 DOM 결과를 검증한다.
- Selection node 재사용 관련 테스트(`reconciler-selection-pool.behavior.test.ts`, `reconciler-selection-preservation.test.ts`, `vnode-selection-anchoring.test.ts`)는 요구 사항 변경으로 제거했다.
- `reconciler-performance.test.ts` 는 문제 분석을 위해 임시 디버그 모드(공통 카운트 10, `[PERF-TEST]` 로그)를 도입했다. 실제 퍼포먼스 수치 복원은 디버깅 완료 후 다시 진행한다.
- 대부분의 핵심 테스트(`component-state-integration`, `mark-wrapper-reuse`, `prevvnode-nextvnode`, `text-vnode`, `advanced-cases` 등)는 이제 동기 모드에서 개별 실행이 가능하며, 결과를 `test/RECONCILE_TEST_RESULTS.md` 등으로 문서화했다.

## 4. 문서화 및 분석 자료
- `packages/renderer-dom/docs/` 아래에 다음 문서를 추가했다.
  - `fiber-sync-mode-implementation.md`, `fiber-sync-vs-async.md`, `renderer-async-consideration.md`: Fiber 동기 모드 설계, 비동기 모드 유지 전략, DOMRenderer 의 재랜더 시나리오를 설명.
  - `mountcomponent-issue-analysis.md`, `decorator-removal-issue.md`, `fiber-dom-structure-issue.md`, `fiber-primitive-text-concept.md`, `fiber-no-arbitrary-elements.md`, `reconciler-fiber-review.md`: 이전에 발견된 DOM 중복, decorator 정리, 텍스트 노드 처리 문제를 분석하고 해결책을 기록.
  - `unused-code-cleanup.md`, `fiber-migration-status.md`: 제거된 유틸과 진행 중인 Fiber 전환 상황을 추적.
- 테스트 결과와 장애 분석은 `test/FAILED_TESTS_ANALYSIS.md`, `FINAL_TEST_RESULTS.md`, `SYNC_MODE_TEST_RESULTS*.md`, `RECONCILE_TEST_CHECKLIST.md` 등에 단계별로 정리했다.

## 5. 기능적 결과 요약
1. **테스트 신뢰도**: 모든 리컨실 관련 테스트가 동기 모드에서 결정론적으로 실행된다. `waitForFiber()` 의존성이 제거되어 유지보수가 단순해졌다.
2. **DOM 안정성**: `prevVNode` 깊은 복사와 향상된 host 매칭으로 동일 sid 요소가 이동하더라도 중복 DOM 생성이나 `mountComponent` 재호출이 발생하지 않는다.
3. **상태 관리**: 빌드 진행 중 `BaseComponentState.set()` 호출이 차단되어 `queueMicrotask` 폭주가 사라졌고, state emit 테스트가 즉시 완료된다.
4. **식별자 일관성**: 자동 sid 는 내부에서만 사용되고 DOM 에 노출되지 않아 모델에서 제공한 sid 와 구분된다. `data-bc-sid` 는 모델 주입 sid 에만 존재한다.
5. **문서 및 분석 체계**: 문제 원인, 해결 전략, 테스트 결과를 별도 문서로 모두 보존하여 향후 회귀 분석 시 참조할 수 있다.

위 변경으로 `renderer-dom` 은 동기 테스트 지원, 안정적인 Fiber 리컨실, 명확한 sid 정책을 갖춘 상태로 정리되었다. 추가 테스트나 성능 조정 시 본 문서를 기준으로 영향을 빠르게 파악할 수 있다.


